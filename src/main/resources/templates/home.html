<html>
	<th:block th:replace="partial/head :: head('Meal Planner')"></th:block>
    <body>
        <th:block th:replace="partial/header"></th:block>
        <div class="container">
            <div class="row">
                <div class="col-12 mt-1 mb-0">
                    <div class="input-group">
                        <input type="search" class="form-control" placeholder="Search" aria-label="Search"
                          aria-describedby="search-addon" />
                        <button type="button" class="input-group-text border-1" data-toggle="modal" data-title="Filter results" data-target="#searchModal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="24" fill="currentColor" class="bi bi-filter" viewBox="0 0 16 16">
                                <path d="M6 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-2-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <ul class="list-group list-group-flush item-list" id="mealTable">
                <th:block th:each="meal:${meals}">
                    <li data-toggle="collapse" th:attr="data-target=${'#accordion_' + meal.id}" class="clickable my-0 accordion-header item list-group-item list-group-item-action">
                        <button class="action edit bg-primary stop-prop" th:attr="onclick=${'editMeal('+meal.id+')'}">Edit</button>
                        <div class="row no-gutters">
                            <div class="round form-check col col-2">
                                <input type="checkbox" class="form-check-input stop-prop meal-select" th:id="${'mealCheckbox_' + meal.id}" th:attr="data-target=${meal.id}">
                                <label class="form-check-label stop-prop" th:attr="for=${'mealCheckbox_' + meal.id}"></label>
                            </div>
                            <div class="meal-text text-truncate col col-9 ps-0" th:text="${meal.name}"></div>
                            <div class="col col-1 text-end mt-1 pe-0">
                                <i class="fa-heart stop-prop" th:classappend="${meal.favorite? 'fas' : 'far'}"></i>
                            </div>
                        </div>
                        <button class="action delete bg-danger">Delete</button>
                    </li>
                    <li th:id="${'accordion_' + meal.id}" class="pt-0 pb-0 px-2 bg-light container accordion-collapse collapse" th:attr="data-target=${meal.id}" data-parent="#mealTable">
                        <h6 th:if="${#lists.size(meal.ingredients) > 0}" class="mt-2">Ingredients</h6>
                        <ul th:if="${#lists.size(meal.ingredients) > 0}" 
                            class="list-group list-group-flush d-flex flex-row flex-wrap bg-secondary">
                            <li th:each="ingredient : ${meal.ingredients}" class="list-group-item border-bottom" th:classappend="${#lists.size(meal.ingredients) == 1? 'w-100':'w-50'}">
                                <small th:text="${ingredient.name}"></small>
                            </li>
                        </ul>
                        <h6 th:if="${#maps.size(meal.tags) > 0}" class="mt-2">Tags</h6>
                        <div th:if="${#maps.size(meal.tags) > 0}" class="row no-gutters">
                            <div class="col">
                                <small>
                                    <span class="badge rounded-pill bg-secondary mx-1 my-1" th:each="tag : ${meal.tags}" th:text="${tag.value}"></span>
                                </small>
                            </div>
                        </div>
                        <h6 th:if="${meal.notes != null}" class="mt-2">Notes</h6>
                        <div th:if="${meal.notes != null}" class="row no-gutters">
                            <div class="col px-4">
                                <small th:text="${meal.notes}"></small>
                            </div>
                        </div>
                        <hr th:if="${#maps.size(meal.tags) > 0}" class="mt-1 mb-0">
                        <div class="row">
                            <div class="col-6 pt-2">
                                <small class="mb-0 text-primary">Last time planned: </small>
                            </div>
                            <div class="col-6 pt-2 text-end">
                                <small th:text="${meal.lastEaten == null? 'Never': meal.getWeeksSinceLastEaten() + ' weeks ago'}"></small>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-6 pt-1">
                                <small class="mb-0 text-primary">Total times planned: </small>
                            </div>
                            <div class="col-6 pt-2 text-end">
                                <small th:text="${meal.lastEaten == null? '0': meal.count}"></small>
                            </div>
                        </div>
                        <div class="my-2 col text-center">
                            <a th:if="${meal.recipeUrl != null}" th:href="${meal.recipeUrl}" target="_blank">View Recipe <i class="ms-1 fas fa-external-link-alt"></i></a>
                        </div>
                    </li>
                </th:block>
            </ul>
        </div>
    </body>
    <button onclick="createMeal()" class="btn btn-primary btn-lg add shadow">
        <i class="fas fa-plus"></i>
    </button>
    <div class="alert alert-success py-2 add-meal text-center" role="alert">
        <label for="addMealsWeekSelect" class="mb-2">Add <span id="addMealCount">1</span> meal(s) to week </label>
        <select id="addMealsWeekSelect" class="form-select form-select-sm text-center">
            <option th:each="week : ${weeks}" th:id="${week.id}" th:text="${#dates.format(week.start,'MM/dd/yyyy') + ' - ' + #dates.format(week.end,'MM/dd/yyyy')}"></option>
        </select>
        <div class="row">
            <div class="col text-center mt-2">
                <button type="button" class="btn btn-success btn-sm px-5">Add</button>
            </div>
        </div>
    </div>
</html>
<script th:inline="javascript">
    let tags;
    let ingredients;
    let unselecting = false;
    $(document).ready(function(){
        refreshIngredients();
        refreshTags();
    });

    $(document).on('click','.far.fa-heart',function(){
        $(this).removeClass('far');
        $(this).addClass('fas');
    });
    $(document).on('click','.fas.fa-heart',function(){
        $(this).removeClass('fas');
        $(this).addClass('far');
    });
    $(document).on('click','.stop-prop', function (e) {
        e.stopPropagation();
    });
    $(document).on('change','input.meal-select:checkbox',function(e){
        if ($('input.meal-select:checkbox:checked').length > 0){
            $('#addMealCount').html($('input.meal-select:checkbox:checked').length)
            $('.alert.add-meal').addClass('display');
        } else {
            $('.alert.add-meal').removeClass('display');
        }
    });
    $('.item-list').listSwipe();

    function refreshTags() {
        $.ajax({
			url: contextpath + 'json/tags',
			method: "GET",
            success: function(data) {
                tags = new Map(Object.entries(data))
            }
        });
    }

    function refreshIngredients() {
        $.ajax({
			url: contextpath + 'json/ingredients',
			method: "GET",
            success: function(data) {
                ingredients = data;
            }
        });
    }

</script>